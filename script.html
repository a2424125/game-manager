<script>
// ì „ì—­ ë³€ìˆ˜
var currentUser = null;
var currentPage = 'dashboard';
var membersCache = null; // íšŒì› ëª©ë¡ ìºì‹œ

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    var appContainer = document.getElementById('appContainer');
    appContainer.style.display = 'none';
    appContainer.style.visibility = 'hidden';
    appContainer.style.opacity = '0';
    appContainer.classList.remove('show');
    
    // bodyì— not-logged-in í´ë˜ìŠ¤ ì¶”ê°€
    document.body.classList.add('not-logged-in');
    
    hideLoader();
    
    // ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
});

// ë¡œë” ê´€ë¦¬
function showLoader() {
    document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

// ë¡œê·¸ì¸/íšŒì›ê°€ì… í† ê¸€
function showRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

function showLogin() {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
}

// ë¡œê·¸ì¸ ì²˜ë¦¬
function handleLogin(e) {
    e.preventDefault();
    showLoader();
    
    var nickname = document.getElementById('loginNickname').value;
    var password = document.getElementById('loginPassword').value;
    
    google.script.run
        .withSuccessHandler(onLoginSuccess)
        .withFailureHandler(onError)
        .login(nickname, password);
}

function onLoginSuccess(result) {
    hideLoader();
    
    if (result.success) {
        currentUser = result.user;
        console.log('ë¡œê·¸ì¸ ì„±ê³µ:', currentUser);
        
        // íšŒì› ëª©ë¡ ìºì‹œ ì´ˆê¸°í™”
        membersCache = null;
        
        showApp();
    } else {
        alert(result.message);
    }
}

// ===== ìˆ˜ì •ëœ íšŒì›ê°€ì… ì²˜ë¦¬ =====
function handleRegister(e) {
    e.preventDefault();
    showLoader();
    
    var password = document.getElementById('regPassword').value;
    var passwordConfirm = document.getElementById('regPasswordConfirm').value;
    
    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (password !== passwordConfirm) {
        hideLoader();
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬
    if (password.length < 6) {
        hideLoader();
        alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    var nickname = document.getElementById('regNickname').value.trim();
    var guild = document.getElementById('regGuild').value.trim();
    var server = document.getElementById('regServer').value.trim();
    var job = document.getElementById('regJob').value.trim();
    
    if (!nickname || !guild || !server || !job) {
        hideLoader();
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    var userData = {
        nickname: nickname,
        guild: guild,
        server: server,
        job: job,
        password: password
    };
    
    console.log('íšŒì›ê°€ì… ìš”ì²­ ë°ì´í„°:', userData);
    
    google.script.run
        .withSuccessHandler(onRegisterSuccess)
        .withFailureHandler(onRegisterError)
        .register(userData);
}

// ===== ìˆ˜ì •ëœ íšŒì›ê°€ì… ì„±ê³µ ì²˜ë¦¬ =====
function onRegisterSuccess(result) {
    hideLoader();
    
    console.log('íšŒì›ê°€ì… ì‘ë‹µ:', result);
    
    if (result.success) {
        // íšŒì› ëª©ë¡ ìºì‹œ ë¬´íš¨í™”
        membersCache = null;
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        alert(result.message);
        
        // í¼ ì´ˆê¸°í™”
        document.getElementById('registerForm').reset();
        
        // ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ì „í™˜
        showLogin();
        
        // íšŒì›ê°€ì…í•œ ë‹‰ë„¤ì„ì„ ë¡œê·¸ì¸ í¼ì— ìë™ ì…ë ¥
        if (result.newMember && result.newMember.nickname) {
            document.getElementById('loginNickname').value = result.newMember.nickname;
            document.getElementById('loginPassword').focus();
        }
        
        console.log('âœ… íšŒì›ê°€ì… ì™„ë£Œ - ìºì‹œ ë¬´íš¨í™”ë¨');
        
    } else {
        alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + result.message);
    }
}

// ===== íšŒì›ê°€ì… ì‹¤íŒ¨ ì²˜ë¦¬ =====
function onRegisterError(error) {
    hideLoader();
    console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
    alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
}

// ì•± í‘œì‹œ
function showApp() {
    // body í´ë˜ìŠ¤ ë³€ê²½
    document.body.classList.remove('not-logged-in');
    document.body.classList.add('logged-in');
    
    // ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    document.getElementById('loginContainer').style.display = 'none';
    
    // ì•± ì»¨í…Œì´ë„ˆ í‘œì‹œ
    var appContainer = document.getElementById('appContainer');
    appContainer.style.display = 'block';
    appContainer.style.visibility = 'visible';
    appContainer.style.opacity = '1';
    appContainer.classList.add('show');
    
    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    document.getElementById('userName').textContent = currentUser.nickname;
    document.getElementById('userRole').textContent = currentUser.isAdmin ? 'ê´€ë¦¬ì' : 'ì¼ë°˜ íšŒì›';
    
    // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ
    if (currentUser.isAdmin) {
        var adminElements = document.querySelectorAll('.admin-only');
        for (var i = 0; i < adminElements.length; i++) {
            adminElements[i].style.removeProperty('display');
            adminElements[i].classList.add('show');
        }
    }
    
    // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    showPage('dashboard');
}

// ë¡œê·¸ì•„ì›ƒ
function logout() {
    currentUser = null;
    membersCache = null; // ìºì‹œ ì´ˆê¸°í™”
    
    // body í´ë˜ìŠ¤ ë³€ê²½
    document.body.classList.remove('logged-in');
    document.body.classList.add('not-logged-in');
    
    // ì•± ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    var appContainer = document.getElementById('appContainer');
    appContainer.classList.remove('show');
    appContainer.style.display = 'none';
    appContainer.style.visibility = 'hidden';
    appContainer.style.opacity = '0';
    
    // ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ í‘œì‹œ
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('loginForm').reset();
}

// í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
function showPage(page) {
    currentPage = page;
    
    // ë©”ë‰´ í™œì„±í™” í‘œì‹œ
    var menuItems = document.querySelectorAll('.menu-item');
    for (var i = 0; i < menuItems.length; i++) {
        menuItems[i].classList.remove('active');
    }
    
    // í´ë¦­ëœ ë©”ë‰´ í™œì„±í™”
    var clickedMenu = null;
    for (var i = 0; i < menuItems.length; i++) {
        var onclick = menuItems[i].getAttribute('onclick');
        if (onclick && onclick.includes(page)) {
            clickedMenu = menuItems[i];
            break;
        }
    }
    if (clickedMenu) {
        clickedMenu.classList.add('active');
    }
    
    // í˜ì´ì§€ ì½˜í…ì¸  ë¡œë“œ
    switch(page) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'members':
            loadMembers();
            break;
        case 'boss-history':
            loadBossHistory();
            break;
        case 'boss-record':
            loadBossRecord();
            break;
        case 'item-sales':
            loadItemSales();
            break;
        case 'guild-funds':
            loadGuildFunds();
            break;
        case 'distribution':
            loadDistribution();
            break;
        case 'statistics':
            loadStatistics();
            break;
        case 'admin':
            loadAdmin();
            break;
    }
}

// ëŒ€ì‹œë³´ë“œ ë¡œë“œ
function loadDashboard() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            hideLoader();
            // ìµœê·¼ í™œë™ ë¡œë“œ
            loadRecentActivities();
        })
        .withFailureHandler(onError)
        .getDashboardHTML();
}

// ìµœê·¼ í™œë™ ë¡œë“œ
function loadRecentActivities() {
    // êµ¬í˜„í•  í•¨ìˆ˜ - ì„ì‹œë¡œ ë¹„ì›Œë‘ 
}

// ===== ìˆ˜ì •ëœ ê¸¸ë“œì› ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ =====
function loadMembers() {
    console.log('ğŸš€ ê¸¸ë“œì› ëª©ë¡ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
    showLoader();
    
    // ë¨¼ì € HTML ë¡œë“œ
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('âœ… HTML ë¡œë“œ ì„±ê³µ');
            document.getElementById('contentWrapper').innerHTML = html;
            
            // HTML ë¡œë“œ í›„ ë°”ë¡œ ë°ì´í„° ë¡œë“œ ì‹œì‘
            loadMembersData();
        })
        .withFailureHandler(function(error) {
            console.error('âŒ HTML ë¡œë“œ ì‹¤íŒ¨:', error);
            hideLoader();
            onError(error);
        })
        .getMembersHTML();
}

// íšŒì› ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
function loadMembersData() {
    console.log('ğŸ“Š íšŒì› ë°ì´í„° ë¡œë“œ ì‹œì‘');
    
    // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
    if (membersCache && membersCache.length > 0) {
        console.log('ğŸ“‹ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©:', membersCache.length + 'ëª…');
        displayMembersTable(membersCache);
        updateMembersStats(membersCache);
        hideLoader();
        
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìƒˆ ë°ì´í„° ë¡œë“œ
        setTimeout(function() {
            refreshMembersDataInBackground();
        }, 500);
        
        return;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ
    google.script.run
        .withSuccessHandler(function(members) {
            console.log('âœ… ì„œë²„ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', members.length + 'ëª…');
            
            // ìºì‹œ ì—…ë°ì´íŠ¸
            membersCache = members;
            
            hideLoader();
            
            if (members && members.length > 0) {
                displayMembersTable(members);
                updateMembersStats(members);
                drawParticipationChart(members);
                console.log('âœ… íšŒì› ëª©ë¡ í‘œì‹œ ì™„ë£Œ');
            } else {
                displayEmptyMembersMessage();
                console.log('âš ï¸ í‘œì‹œí•  íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤');
            }
        })
        .withFailureHandler(function(error) {
            console.error('âŒ ì„œë²„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            hideLoader();
            displayErrorMessage('íšŒì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getMembers();
}

// ë°±ê·¸ë¼ìš´ë“œì—ì„œ íšŒì› ë°ì´í„° ìƒˆë¡œê³ ì¹¨
function refreshMembersDataInBackground() {
    console.log('ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
    
    google.script.run
        .withSuccessHandler(function(members) {
            console.log('âœ… ë°±ê·¸ë¼ìš´ë“œ ìƒˆë¡œê³ ì¹¨ ì„±ê³µ:', members.length + 'ëª…');
            
            // ìºì‹œ ì—…ë°ì´íŠ¸
            var oldCount = membersCache ? membersCache.length : 0;
            membersCache = members;
            
            // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ìë™ ì—…ë°ì´íŠ¸
            if (oldCount !== members.length) {
                console.log('ğŸ“Š ë°ì´í„° ë³€ê²½ ê°ì§€ - ìë™ ì—…ë°ì´íŠ¸');
                displayMembersTable(members);
                updateMembersStats(members);
                drawParticipationChart(members);
            }
        })
        .withFailureHandler(function(error) {
            console.warn('âš ï¸ ë°±ê·¸ë¼ìš´ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        })
        .forceRefreshMembers();
}

// ===== íšŒì› í…Œì´ë¸” í‘œì‹œ í•¨ìˆ˜ ê°œì„  =====
function displayMembersTable(members) {
    console.log('ğŸ“‹ íšŒì› í…Œì´ë¸” í‘œì‹œ ì‹œì‘:', members.length + 'ëª…');
    
    var tbody = document.getElementById('membersTableBody');
    if (!tbody) {
        console.error('âŒ í…Œì´ë¸” ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    var html = '';
    
    for (var i = 0; i < members.length; i++) {
        var member = members[i];
        
        // ì•ˆì „í•œ ê°’ ì ‘ê·¼
        var nickname = member.nickname || 'Unknown';
        var guild = member.guild || '-';
        var server = member.server || '-';
        var job = member.job || '-';
        var status = member.status || 'í™œì„±';
        var participationCount = member.participationCount || 0;
        var joinDate = member.joinDate ? new Date(member.joinDate).toLocaleDateString() : '-';
        var lastParticipation = member.lastParticipation ? new Date(member.lastParticipation).toLocaleDateString() : '-';
        var isAdmin = member.isAdmin ? 'ê´€ë¦¬ì' : 'ì¼ë°˜íšŒì›';
        
        // ìƒíƒœë³„ í´ë˜ìŠ¤
        var statusClass = status === 'í™œì„±' ? 'active' : 'inactive';
        var rowClass = 'member-row';
        
        // ì°¸ì—¬ìœ¨ ê³„ì‚° (ì´ ì°¸ì—¬ ëŒ€ë¹„)
        var totalParticipation = members.reduce(function(sum, m) { return sum + (m.participationCount || 0); }, 0);
        var participationRate = totalParticipation > 0 ? Math.round((participationCount / totalParticipation) * 100) : 0;
        
        // ì§ì—…ë³„ ìƒ‰ìƒ
        var jobColor = getJobColor(job);
        
        html += '<tr class="' + rowClass + '" data-status="' + status + '" data-job="' + job + '" onclick="showMemberDetail(\'' + nickname + '\')">' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td>' +
                '<div class="member-name-cell">' +
                    '<div class="member-avatar-sm">' +
                        '<span class="avatar-text">' + nickname.charAt(0) + '</span>' +
                    '</div>' +
                    '<span class="member-nickname">' + nickname + '</span>' +
                '</div>' +
            '</td>' +
            '<td>' + guild + '</td>' +
            '<td>' + server + '</td>' +
            '<td><span class="job-badge" style="background-color: ' + jobColor + '; color: white;">' + job + '</span></td>' +
            '<td>' + joinDate + '</td>' +
            '<td><span class="status-badge ' + statusClass + '">' + status + '</span></td>' +
            '<td class="participation-cell">' + participationCount + 'íšŒ</td>' +
            '<td>' +
                '<div class="participation-rate">' +
                    '<div class="rate-bar">' +
                        '<div class="rate-fill" style="width: ' + Math.min(participationRate, 100) + '%"></div>' +
                    '</div>' +
                    '<span class="rate-text">' + participationRate + '%</span>' +
                '</div>' +
            '</td>' +
            '<td>' + lastParticipation + '</td>' +
            '<td><span class="role-badge ' + (member.isAdmin ? 'admin' : 'member') + '">' + isAdmin + '</span></td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
    console.log('âœ… í…Œì´ë¸” í‘œì‹œ ì™„ë£Œ');
}

// ===== ê°•ì œ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ë“¤ =====
function forceRefreshMembersData() {
    console.log('ğŸ’ª ê°•ì œ íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
    showLoader();
    
    // ìºì‹œ ë¬´íš¨í™”
    membersCache = null;
    
    google.script.run
        .withSuccessHandler(function(members) {
            console.log('âœ… ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì„±ê³µ:', members.length + 'ëª…');
            
            // ìºì‹œ ì—…ë°ì´íŠ¸
            membersCache = members;
            
            hideLoader();
            
            if (members && members.length > 0) {
                displayMembersTable(members);
                updateMembersStats(members);
                drawParticipationChart(members);
                
                // ì„±ê³µ ë©”ì‹œì§€ (ì„ íƒì )
                console.log('ğŸ‰ íšŒì› ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                displayEmptyMembersMessage();
                
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì œì•ˆ
                if (confirm('ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.\ní…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    createTestDataNow();
                }
            }
        })
        .withFailureHandler(function(error) {
            console.error('âŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            hideLoader();
            displayErrorMessage('ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .forceRefreshMembers();
}

// ===== í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± =====
function createTestDataNow() {
    console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹œì‘');
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ:', result);
            hideLoader();
            
            if (result.success) {
                alert(result.message);
                
                // ìºì‹œ ë¬´íš¨í™” í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                membersCache = null;
                setTimeout(function() {
                    loadMembersData();
                }, 1000);
            } else {
                alert('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + result.message);
            }
        })
        .withFailureHandler(function(error) {
            console.error('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', error);
            hideLoader();
            alert('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + error.message);
        })
        .setupCompleteTestEnvironment();
}

// í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì•ˆì „ì„± ê°œì„ )
function updateMembersStats(members) {
    console.log('ğŸ“Š íšŒì› í†µê³„ ì—…ë°ì´íŠ¸:', members.length + 'ëª…');
    
    var total = members ? members.length : 0;
    var active = members ? members.filter(function(m) { return m.status === 'í™œì„±'; }).length : 0;
    var inactive = total - active;
    var totalParticipation = members ? members.reduce(function(sum, member) {
        return sum + (member.participationCount || 0);
    }, 0) : 0;
    
    // ì•ˆì „í•˜ê²Œ ìš”ì†Œ ì—…ë°ì´íŠ¸
    function updateElementText(id, text) {
        var element = document.getElementById(id);
        if (element) {
            element.textContent = text;
            console.log(`í†µê³„ ì—…ë°ì´íŠ¸: ${id} = ${text}`);
        } else {
            console.warn('ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
        }
    }
    
    updateElementText('totalMembersCount', total + 'ëª…');
    updateElementText('activeMembersCount', active + 'ëª…');
    updateElementText('inactiveMembersCount', inactive + 'ëª…');
    updateElementText('totalParticipationCount', totalParticipation + 'íšŒ');
    
    console.log('âœ… í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ - ì´:', total, 'í™œì„±:', active, 'ì°¸ì—¬:', totalParticipation);
}

// ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ (ê°œì„ ë¨)
function displayEmptyMembersMessage() {
    console.log('ğŸ“ ë¹ˆ íšŒì› ë©”ì‹œì§€ í‘œì‹œ');
    
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="empty-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px;">people_outline</span>' +
                '<p><strong>ë“±ë¡ëœ ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤</strong></p>' +
                '<p style="font-size: 14px; color: #aaa; margin: 8px 0;">ìƒˆë¡œ ê°€ì…í•œ íšŒì›ì´ ìˆë‹¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>' +
                '<div style="margin-top: 20px;">' +
                    '<button class="btn btn-primary" onclick="forceRefreshMembersData(); return false;" style="margin-right: 10px;">ê¸¸ë“œì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>' +
                    '<button class="btn btn-secondary" onclick="createTestDataNow(); return false;">í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</button>' +
                '</div>' +
            '</div>' +
        '</td></tr>';
    }
    
    // í†µê³„ë„ 0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    updateMembersStats([]);
}

// ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (ê°œì„ ë¨)
function displayErrorMessage(message) {
    console.log('âŒ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ:', message);
    
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="error-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px; color: #f44336;">error</span>' +
                '<p style="color: #f44336; font-weight: 500;"><strong>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong></p>' +
                '<p style="font-size: 14px; margin: 8px 0;">' + message + '</p>' +
                '<div style="margin-top: 20px;">' +
                    '<button class="btn btn-primary" onclick="forceRefreshMembersData(); return false;" style="margin-right: 10px;">ë‹¤ì‹œ ì‹œë„</button>' +
                    '<button class="btn btn-secondary" onclick="loadMembers(); return false;">í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>' +
                '</div>' +
            '</div>' +
        '</td></tr>';
    }
    
    // í†µê³„ë„ 0ìœ¼ë¡œ ì—…ë°ì´íŠ¸  
    updateMembersStats([]);
}

// ===== ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ë“¤ =====
function exportMembersList() {
    console.log('ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ (ê¸°ì¡´ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼)');
    forceRefreshMembersData();
}

function refreshMembersList() {
    console.log('ê¸¸ë“œì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
    forceRefreshMembersData();
}

// ê²€ìƒ‰ ë° í•„í„°ë§ í•¨ìˆ˜ë“¤ (ê°œì„ ë¨)
function searchMembers(keyword) {
    console.log('íšŒì› ê²€ìƒ‰:', keyword);
    
    var rows = document.querySelectorAll('.member-row');
    var lowerKeyword = keyword.toLowerCase();
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var nicknameElement = row.querySelector('.member-nickname');
        
        if (nicknameElement) {
            var nickname = nicknameElement.textContent.toLowerCase();
            
            if (!keyword || nickname.includes(lowerKeyword)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    console.log('ê²€ìƒ‰ ê²°ê³¼:', visibleCount + 'ëª… í‘œì‹œ');
}

function filterMembers(status) {
    console.log('íšŒì› ìƒíƒœ í•„í„°:', status);
    
    var rows = document.querySelectorAll('.member-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberStatus = row.getAttribute('data-status');
        
        if (status === 'all' || memberStatus === status) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    console.log('í•„í„° ê²°ê³¼:', visibleCount + 'ëª… í‘œì‹œ');
}

function filterMembersByJob(job) {
    console.log('íšŒì› ì§ì—… í•„í„°:', job);
    
    var rows = document.querySelectorAll('.member-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberJob = row.getAttribute('data-job');
        
        if (job === 'all' || memberJob === job) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    console.log('ì§ì—… í•„í„° ê²°ê³¼:', visibleCount + 'ëª… í‘œì‹œ');
}

// ì •ë ¬ í•¨ìˆ˜ (ê°œì„ ë¨)
function sortMembers(sortBy) {
    console.log('íšŒì› ì •ë ¬:', sortBy);
    // í˜„ì¬ëŠ” ë‹¨ìˆœíˆ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì§€ë§Œ, ë‚˜ì¤‘ì— í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬ë¡œ ê°œì„  ê°€ëŠ¥
    forceRefreshMembersData();
}

// íšŒì› ìƒì„¸ ì •ë³´ í‘œì‹œ
function showMemberDetail(nickname) {
    console.log('íšŒì› ìƒì„¸ ì •ë³´ í‘œì‹œ:', nickname);
    
    // í˜„ì¬ëŠ” ê°„ë‹¨í•œ ì•Œë¦¼ë§Œ í‘œì‹œ, ë‚˜ì¤‘ì— ëª¨ë‹¬ë¡œ ê°œì„  ê°€ëŠ¥
    alert('íšŒì› ìƒì„¸ ì •ë³´: ' + nickname + '\n\nìƒì„¸ ì •ë³´ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\n\nêµ¬í˜„ ì˜ˆì • ê¸°ëŠ¥:\n- ì°¸ì—¬ íˆìŠ¤í† ë¦¬\n- íšë“ ì•„ì´í…œ\n- í™œë™ í†µê³„\n- ë©”ëª¨ ê´€ë¦¬');
}

// ì°¸ì—¬ìœ¨ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
function drawParticipationChart(members) {
    console.log('ì°¸ì—¬ìœ¨ ì°¨íŠ¸ ê·¸ë¦¬ê¸°');
    
    var canvas = document.getElementById('participationChart');
    if (canvas && members && members.length > 0) {
        var ctx = canvas.getContext('2d');
        
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ë°°ê²½
        ctx.fillStyle = '#F8FAFC';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ì°¨íŠ¸ ì œëª©
        ctx.fillStyle = '#00BCD4';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ì°¸ì—¬ìœ¨ ë¶„í¬', canvas.width/2, canvas.height/2 - 20);
        
        // ë¶€ì œëª©
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.fillText('ì´ ' + members.length + 'ëª…ì˜ ê¸¸ë“œì›', canvas.width/2, canvas.height/2);
        
        // ìƒˆë¡œê³ ì¹¨ ì•ˆë‚´
        ctx.font = '12px Arial';
        ctx.fillStyle = '#999';
        ctx.fillText('â€» ìƒì„¸ ì°¨íŠ¸ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤', canvas.width/2, canvas.height/2 + 25);
        
        console.log('ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì™„ë£Œ');
    } else if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#E0E0E0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ë°ì´í„° ì—†ìŒ', canvas.width/2, canvas.height/2);
    }
}

// ì§ì—…ë³„ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
function getJobColor(job) {
    var jobColors = {
        // ì „ì‚¬ ê³„ì—´ - ë¹¨ê°„ìƒ‰ ê³„ì—´
        'ë²„ì„œì»¤': '#E53E3E',
        'ë””ìŠ¤íŠ¸ë¡œì´ì–´': '#C53030',
        'ì›Œë¡œë“œ': '#9B2C2C',
        'í™€ë¦¬ë‚˜ì´íŠ¸': '#742A2A',
        'ìŠ¬ë ˆì´ì–´': '#E53E3E',
        
        // ë¬´ë„ê°€ ê³„ì—´ - ì£¼í™©ìƒ‰ ê³„ì—´
        'ë°°í‹€ë§ˆìŠ¤í„°': '#DD6B20',
        'ì¸íŒŒì´í„°': '#C05621',
        'ê¸°ê³µì‚¬': '#9C4221',
        'ì°½ìˆ ì‚¬': '#7B341E',
        'ìŠ¤íŠ¸ë¼ì´ì»¤': '#DD6B20',
        'ë¸Œë ˆì´ì»¤': '#C05621',
        
        // ê±´ë„ˆ ê³„ì—´ - ë…¹ìƒ‰ ê³„ì—´
        'ê±´ìŠ¬ë§ì–´': '#38A169',
        'ì•„ë¥´í‹°ìŠ¤íŠ¸': '#2F855A',
        'ë°ë¹Œí—Œí„°': '#276749',
        'ë¸”ë˜ìŠ¤í„°': '#22543D',
        'í˜¸í¬ì•„ì´': '#1A202C',
        'ìŠ¤ì¹´ìš°í„°': '#38A169',
        
        // ë§ˆë²•ì‚¬ ê³„ì—´ - íŒŒë€ìƒ‰ ê³„ì—´
        'ë°”ë“œ': '#3182CE',
        'ì„œë¨¸ë„ˆ': '#2B6CB0',
        'ì•„ë¥´ì¹´ë‚˜': '#2C5282',
        'ì†Œì„œë¦¬ìŠ¤': '#2A4365',
        
        // ì•”ì‚´ì ê³„ì—´ - ë³´ë¼ìƒ‰ ê³„ì—´
        'ë¸”ë ˆì´ë“œ': '#805AD5',
        'ë°ëª¨ë‹‰': '#6B46C1',
        'ë¦¬í¼': '#553C9A',
        'ì†Œìš¸ì´í„°': '#44337A',
        
        // ìŠ¤í˜ì…œë¦¬ìŠ¤íŠ¸ ê³„ì—´ - íŠ¹ë³„ìƒ‰
        'ë„í™”ê°€': '#D69E2E',
        'ê¸°ìƒìˆ ì‚¬': '#00B5D8'
    };
    
    return jobColors[job] || '#718096'; // ê¸°ë³¸ íšŒìƒ‰
}

// ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ê³„ì† =====

// ë³´ìŠ¤ ì°¸ì—¬ ë“±ë¡ ë¡œë“œ
function loadBossRecord() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            document.getElementById('bossRecordForm').addEventListener('submit', handleBossRecord);
            hideLoader();
        })
        .withFailureHandler(onError)
        .getBossRecordHTML();
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleImageUpload(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var base64 = e.target.result.split(',')[1];
            extractParticipants(base64);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Gemini APIë¡œ ì°¸ì—¬ì ì¶”ì¶œ
function extractParticipants(base64) {
    showLoader();
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                displayExtractedParticipants(result.nicknames);
            } else {
                alert(result.message);
            }
            hideLoader();
        })
        .withFailureHandler(onError)
        .extractParticipantsFromImage(base64);
}

// ì¶”ì¶œëœ ì°¸ì—¬ì í‘œì‹œ
function displayExtractedParticipants(nicknames) {
    var container = document.getElementById('extractedParticipants');
    var list = document.getElementById('participantList');
    
    container.style.display = 'block';
    list.innerHTML = '';
    
    window.extractedNicknames = nicknames; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
    
    for (var i = 0; i < nicknames.length; i++) {
        var item = document.createElement('div');
        item.className = 'participant-item';
        item.innerHTML = '<span>' + nicknames[i] + '</span>' +
            '<button class="btn btn-sm" onclick="removeParticipant(' + i + ')">' +
            '<span class="material-icons">close</span></button>';
        list.appendChild(item);
    }
    
    updateParticipantCount();
}

// ì°¸ì—¬ì ì œê±°
function removeParticipant(index) {
    window.extractedNicknames.splice(index, 1);
    displayExtractedParticipants(window.extractedNicknames);
}

// ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸
function updateParticipantCount() {
    var extracted = document.querySelectorAll('.participant-item').length;
    var additionalInput = document.getElementById('additionalParticipants');
    var additional = 0;
    
    if (additionalInput && additionalInput.value) {
        var additionalList = additionalInput.value.split(',');
        additional = additionalList.filter(function(p) { 
            return p.trim(); 
        }).length;
    }
    
    var totalElement = document.getElementById('totalParticipants');
    if (totalElement) {
        totalElement.textContent = (extracted + additional) + 'ëª…';
    }
}

// ë³´ìŠ¤ ê¸°ë¡ ì €ì¥
function handleBossRecord(e) {
    e.preventDefault();
    showLoader();
    
    var participants = [];
    
    // ì¶”ì¶œëœ ì°¸ì—¬ì
    if (window.extractedNicknames) {
        participants = participants.concat(window.extractedNicknames);
    }
    
    // ì¶”ê°€ ì°¸ì—¬ì
    var additional = document.getElementById('additionalParticipants').value;
    if (additional) {
        var additionalList = additional.split(',');
        for (var i = 0; i < additionalList.length; i++) {
            var participant = additionalList[i].trim();
            if (participant) {
                participants.push(participant);
            }
        }
    }
    
    var recordData = {
        bossName: document.getElementById('bossName').value,
        participants: participants,
        item: document.getElementById('itemName').value,
        itemCount: parseInt(document.getElementById('itemCount').value) || 0
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                alert(result.message);
                
                // íšŒì› ëª©ë¡ ìºì‹œ ë¬´íš¨í™” (ìƒˆë¡œìš´ ì°¸ì—¬ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ)
                membersCache = null;
                
                loadBossRecord(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            }
            hideLoader();
        })
        .withFailureHandler(onError)
        .saveBossRecord(recordData);
}

// ì•„ì´í…œ íŒë§¤ í˜ì´ì§€ ë¡œë“œ
function loadItemSales() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            loadUnsoldItems();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getItemSalesHTML();
}

// ê¸¸ë“œ ìê¸ˆ í˜ì´ì§€ ë¡œë“œ
function loadGuildFunds() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            var form = document.getElementById('fundTransactionForm');
            if (form) {
                form.addEventListener('submit', handleFundTransaction);
            }
            loadTransactionHistory();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getGuildFundsHTML();
}

// ê¸°íƒ€ í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ë“¤
function loadBossHistory() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            loadBossHistoryData();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getBossHistoryHTML();
}

function loadDistribution() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            hideLoader();
        })
        .withFailureHandler(onError)
        .getDistributionHTML();
}

// í†µê³„ í˜ì´ì§€ ë¡œë“œ
function loadStatistics() {
    console.log('í†µê³„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
    showLoader();
    
    // ë¨¼ì € HTMLì„ ë¡œë“œí•œ í›„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('í†µê³„ HTML ë¡œë“œ ì„±ê³µ');
            document.getElementById('contentWrapper').innerHTML = html;
            // HTMLì´ ë¡œë“œëœ í›„ ë°ì´í„° ë¡œë“œ
            loadStatisticsData();
            hideLoader();
        })
        .withFailureHandler(function(error) {
            console.error('í†µê³„ HTML ë¡œë“œ ì‹¤íŒ¨:', error);
            onError(error);
        })
        .getStatisticsHTML();
}

function loadStatisticsData() {
    console.log('í†µê³„ ë°ì´í„° ë¡œë“œ ì‹œì‘');
    
    // ë³´ìŠ¤ í†µê³„ ë¡œë“œ
    google.script.run
        .withSuccessHandler(function(statistics) {
            console.log('ë³´ìŠ¤ í†µê³„ ë¡œë“œ ì„±ê³µ:', statistics);
            if (statistics && statistics.bossStats && statistics.memberStats) {
                displayParticipationRanking(statistics.memberStats);
                displayBossStatisticsChart(statistics.bossStats);
            } else {
                console.warn('í†µê³„ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                displayEmptyStatistics();
            }
        })
        .withFailureHandler(function(error) {
            console.error('ë³´ìŠ¤ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            displayEmptyStatistics();
        })
        .getBossStatistics();
}

function displayEmptyStatistics() {
    // ì°¸ì—¬ìœ¨ ìˆœìœ„ í…Œì´ë¸”ì— ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ
    var participationTbody = document.getElementById('participationRankingBody');
    if (participationTbody) {
        participationTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    // ë³´ìŠ¤ í†µê³„ì— ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ
    var bossStatsDiv = document.getElementById('bossStatistics');
    if (bossStatsDiv) {
        bossStatsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ë³´ìŠ¤ í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

function displayParticipationRanking(memberStats) {
    console.log('ì°¸ì—¬ìœ¨ ìˆœìœ„ í‘œì‹œ ì‹œì‘:', memberStats);
    var tbody = document.getElementById('participationRankingBody');
    if (!tbody) {
        console.error('participationRankingBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    var html = '';
    var totalParticipation = 0;
    
    // ì „ì²´ ì°¸ì—¬ íšŸìˆ˜ ê³„ì‚°
    for (var i = 0; i < memberStats.length; i++) {
        totalParticipation += memberStats[i].totalParticipation;
    }
    
    for (var i = 0; i < Math.min(memberStats.length, 15); i++) {
        var member = memberStats[i];
        var participationRate = totalParticipation > 0 ? 
            Math.round((member.totalParticipation / totalParticipation) * 100) : 0;
        
        html += '<tr>' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td><strong>' + member.nickname + '</strong></td>' +
            '<td>-</td>' + // ì§ì—… ì •ë³´
            '<td>' + member.totalParticipation + 'íšŒ</td>' +
            '<td>' + participationRate + '%</td>' +
            '<td>-</td>' + // íšë“ ì•„ì´í…œ
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
    console.log('ì°¸ì—¬ìœ¨ ìˆœìœ„ í‘œì‹œ ì™„ë£Œ');
}

function displayBossStatisticsChart(bossStats) {
    console.log('ë³´ìŠ¤ í†µê³„ ì°¨íŠ¸ í‘œì‹œ ì‹œì‘:', bossStats);
    var container = document.getElementById('bossStatistics');
    if (!container) {
        console.error('bossStatistics ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    var html = '<div class="boss-stats-cards">';
    
    for (var i = 0; i < bossStats.length; i++) {
        var stat = bossStats[i];
        html += '<div class="boss-stat-card">' +
            '<h4>' + stat.bossName + '</h4>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">ì´ ë ˆì´ë“œ</span>' +
                '<span class="stat-value">' + stat.totalRaids + 'íšŒ</span>' +
            '</div>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">í‰ê·  ì°¸ì—¬ì</span>' +
                '<span class="stat-value">' + stat.averageParticipants + 'ëª…</span>' +
            '</div>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">ì´ ì•„ì´í…œ</span>' +
                '<span class="stat-value">' + stat.totalItems + 'ê°œ</span>' +
            '</div>' +
        '</div>';
    }
    
    html += '</div>';
    
    if (bossStats.length === 0) {
        html = '<p style="text-align: center; color: #999; padding: 40px;">ë³´ìŠ¤ í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
    
    container.innerHTML = html;
    console.log('ë³´ìŠ¤ í†µê³„ ì°¨íŠ¸ í‘œì‹œ ì™„ë£Œ');
}

// ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ
function loadAdmin() {
    if (!currentUser || !currentUser.isAdmin) {
        alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    console.log('ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('ê´€ë¦¬ì HTML ë¡œë“œ ì„±ê³µ');
            document.getElementById('contentWrapper').innerHTML = html;
            
            // ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™”
            initializeAdminPage();
            
            hideLoader();
        })
        .withFailureHandler(function(error) {
            console.error('ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            onError(error);
        })
        .getAdminHTML();
}

// ì‚¬ì´ë“œë°” í† ê¸€
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

// ìˆ«ì í¬ë§·
function formatNumber(num) {
    return new Intl.NumberFormat('ko-KR').format(num);
}

// ì—ëŸ¬ ì²˜ë¦¬
function onError(error) {
    hideLoader();
    console.error('Error:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || error));
}

// ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
function drawDoughnutChart(canvas) {
    var ctx = canvas.getContext('2d');
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;
    var radius = 80;
    
    // ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ê°„ë‹¨í•œ ì˜ˆì‹œ)
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = '#E0E0E0';
    ctx.lineWidth = 20;
    ctx.stroke();
    
    // ì‹¤ì œ ë°ì´í„° ë¶€ë¶„
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI/2, Math.PI);
    ctx.strokeStyle = '#00BCD4';
    ctx.lineWidth = 20;
    ctx.stroke();
}

// ê¸°íƒ€ ë¹ˆ í•¨ìˆ˜ë“¤ (í•„ìš”ì‹œ êµ¬í˜„)
function loadUnsoldItems() {
    // ë¯¸íŒë§¤ ì•„ì´í…œ ë¡œë“œ ë¡œì§
}

function loadTransactionHistory() {
    // ê±°ë˜ ë‚´ì—­ ë¡œë“œ ë¡œì§
}

// ë³´ìŠ¤ íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ
function loadBossHistoryData() {
    // ë³´ìŠ¤ í†µê³„ ë¡œë“œ
    google.script.run
        .withSuccessHandler(function(statistics) {
            displayBossStatistics(statistics.bossStats);
            displayMemberStatistics(statistics.memberStats);
        })
        .withFailureHandler(onError)
        .getBossStatistics();
    
    // ìµœê·¼ ë³´ìŠ¤ ê¸°ë¡ ë¡œë“œ
    google.script.run
        .withSuccessHandler(displayRecentBossHistory)
        .withFailureHandler(onError)
        .getRecentBossRecords(20);
}

// ë³´ìŠ¤ í†µê³„ í‘œì‹œ
function displayBossStatistics(bossStats) {
    var tbody = document.getElementById('bossStatsTable');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < bossStats.length; i++) {
        var stat = bossStats[i];
        html += '<tr>' +
            '<td><strong>' + stat.bossName + '</strong></td>' +
            '<td>' + stat.totalRaids + 'íšŒ</td>' +
            '<td>' + stat.averageParticipants + 'ëª…</td>' +
            '<td>' + stat.uniqueParticipants + 'ëª…</td>' +
            '<td>' + stat.totalItems + 'ê°œ</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">ë“±ë¡ëœ ë³´ìŠ¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

// ë©¤ë²„ í†µê³„ í‘œì‹œ
function displayMemberStatistics(memberStats) {
    var tbody = document.getElementById('participationRankingTable');
    if (!tbody) return;
    
    var html = '';
    var totalParticipation = 0;
    
    // ì „ì²´ ì°¸ì—¬ íšŸìˆ˜ ê³„ì‚°
    for (var i = 0; i < memberStats.length; i++) {
        totalParticipation += memberStats[i].totalParticipation;
    }
    
    for (var i = 0; i < Math.min(memberStats.length, 10); i++) {
        var member = memberStats[i];
        var participationRate = totalParticipation > 0 ? 
            Math.round((member.totalParticipation / totalParticipation) * 100) : 0;
        
        html += '<tr>' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td><strong>' + member.nickname + '</strong></td>' +
            '<td>-</td>' + // ì§ì—… ì •ë³´ëŠ” ì¶”í›„ ì—°ë™
            '<td>' + member.totalParticipation + 'íšŒ</td>' +
            '<td>' + participationRate + '%</td>' +
            '<td>' + new Date(member.lastParticipation).toLocaleDateString() + '</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

// ìµœê·¼ ë³´ìŠ¤ íˆìŠ¤í† ë¦¬ í‘œì‹œ
function displayRecentBossHistory(recentRecords) {
    var tbody = document.getElementById('recentBossHistory');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < recentRecords.length; i++) {
        var record = recentRecords[i];
        
        // ì°¸ì—¬ì ë°°ì§€ ìƒì„±
        var participantBadges = '';
        var colors = ['bg-green', 'bg-yellow', 'bg-blue', 'bg-purple', 'bg-orange'];
        
        for (var j = 0; j < Math.min(record.participants.length, 4); j++) {
            var participant = record.participants[j];
            var colorClass = colors[j % colors.length];
            participantBadges += '<span class="badge-circle ' + colorClass + '">' + 
                participant.substring(0, 1) + '</span>';
        }
        
        if (record.participants.length > 4) {
            participantBadges += '<span class="badge-more">+' + (record.participants.length - 4) + '</span>';
        }
        
        // íŒë§¤ ìƒíƒœ ë°°ì§€
        var statusClass = record.soldStatus === 'íŒë§¤ì™„ë£Œ' ? 'completed' : 'pending';
        
        html += '<tr>' +
            '<td>' + new Date(record.date).toLocaleDateString() + '</td>' +
            '<td><strong>' + record.bossName + '</strong></td>' +
            '<td><div class="participant-badges">' + participantBadges + '</div></td>' +
            '<td>' + (record.item || '-') + '</td>' +
            '<td><span class="status-badge ' + statusClass + '">' + record.soldStatus + '</span></td>' +
            '<td>' + (record.salePrice > 0 ? formatNumber(record.salePrice) + 'ì›' : '-') + '</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">ìµœê·¼ ë³´ìŠ¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

function handleFundTransaction(e) {
    e.preventDefault();
    // ìê¸ˆ ê±°ë˜ ì²˜ë¦¬ ë¡œì§
}

function previewDistribution() {
    var weekNum = document.getElementById('targetWeek').value;
    var totalAmount = parseInt(document.getElementById('distributionAmount').value);
    
    if (!totalAmount || totalAmount <= 0) {
        alert('ë¶„ë°° ì´ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(distributions) {
            displayDistributionPreview(distributions, totalAmount);
            document.getElementById('distributionPreview').style.display = 'block';
            hideLoader();
        })
        .withFailureHandler(onError)
        .calculateWeeklyDistribution(weekNum);
}

function displayDistributionPreview(distributions, totalAmount) {
    var tbody = document.querySelector('#previewTable tbody');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < distributions.length; i++) {
        var dist = distributions[i];
        var baseAmount = Math.floor(totalAmount * (parseFloat(dist.rate) / 100));
        
        html += '<tr>' +
            '<td>' + (i + 1) + '</td>' +
            '<td><strong>' + dist.nickname + '</strong></td>' +
            '<td>' + dist.count + 'íšŒ</td>' +
            '<td>' + dist.rate + '%</td>' +
            '<td>' + formatNumber(baseAmount) + 'ì›</td>' +
            '<td><strong>' + formatNumber(baseAmount) + 'ì›</strong></td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">í•´ë‹¹ ì£¼ì°¨ì— ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

function executeDistribution() {
    if (!confirm('ì •ë§ë¡œ ë¶„ë°°ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‹¤í–‰ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    var weekNum = document.getElementById('targetWeek').value;
    var totalAmount = parseInt(document.getElementById('distributionAmount').value);
    
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(distributions) {
            // ë¶„ë°° ì‹¤í–‰ ë¡œì§ì€ ì¶”í›„ êµ¬í˜„
            alert('ë¶„ë°°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            hideLoader();
        })
        .withFailureHandler(onError)
        .calculateWeeklyDistribution(weekNum);
}

function closeSellModal() {
    var modal = document.getElementById('sellModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function closeEditModal() {
    var modal = document.getElementById('editMemberModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function filterBossHistory() {
    var periodFilter = document.getElementById('periodFilter').value;
    var bossFilter = document.getElementById('bossFilter').value;
    
    // í•„í„° ì ìš©í•˜ì—¬ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    var filter = {
        period: periodFilter,
        boss: bossFilter
    };
    
    showLoader();
    
    // í•„í„°ëœ ë°ì´í„°ë¡œ í†µê³„ ê°±ì‹ 
    google.script.run
        .withSuccessHandler(function(statistics) {
            displayBossStatistics(statistics.bossStats);
            displayMemberStatistics(statistics.memberStats);
            hideLoader();
        })
        .withFailureHandler(function(error) {
            onError(error);
            hideLoader();
        })
        .getBossStatistics();
}

function exportBossHistory() {
    // CSV ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ (ì¶”í›„ êµ¬í˜„)
    alert('ë³´ìŠ¤ íˆìŠ¤í† ë¦¬ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

// ê´€ë¦¬ì ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€)
function initializeAdminPage() {
    // ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§
}

function showAdminTab(tabName) {
    // ê´€ë¦¬ì íƒ­ ì „í™˜ ë¡œì§
}

function createBackup() {
    if (confirm('ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoader();
                alert(result.message);
            })
            .withFailureHandler(onError)
            .createBackup();
    }
}

function runDataValidation() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(errors) {
            hideLoader();
            if (errors.length === 0) {
                alert('ë°ì´í„° ê²€ì¦ ì™„ë£Œ: ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
            } else {
                alert('ë°ì´í„° ê²€ì¦ ì˜¤ë¥˜:\n' + errors.join('\n'));
            }
        })
        .withFailureHandler(onError)
        .validateData();
}

function updateInactiveMembers() {
    if (confirm('30ì¼ ì´ìƒ ë¯¸ì°¸ì—¬ íšŒì›ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function() {
                hideLoader();
                alert('ë¹„í™œì„± íšŒì› ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                // íšŒì› ëª©ë¡ ìºì‹œ ë¬´íš¨í™”
                membersCache = null;
            })
            .withFailureHandler(onError)
            .batchUpdateMemberStatus();
    }
}

function initializeAllSheets() {
    if (confirm('ëª¨ë“  ì‹œíŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoader();
                alert(result.message);
                // ìºì‹œ ë¬´íš¨í™”
                membersCache = null;
            })
            .withFailureHandler(onError)
            .initializeAllSheets();
    }
}
</script>
