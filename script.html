<script>
// 전역 변수
var currentUser = null;
var currentPage = 'dashboard';

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    console.log('페이지 로드 완료');
    
    // 초기 상태 설정
    var appContainer = document.getElementById('appContainer');
    appContainer.style.display = 'none';
    appContainer.style.visibility = 'hidden';
    appContainer.style.opacity = '0';
    appContainer.classList.remove('show');
    
    // body에 not-logged-in 클래스 추가
    document.body.classList.add('not-logged-in');
    
    hideLoader();
    
    // 로그인 폼 이벤트
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
});

// 로더 관리
function showLoader() {
    document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

// 로그인/회원가입 토글
function showRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

function showLogin() {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
}

// 로그인 처리
function handleLogin(e) {
    e.preventDefault();
    showLoader();
    
    var nickname = document.getElementById('loginNickname').value;
    var password = document.getElementById('loginPassword').value;
    
    google.script.run
        .withSuccessHandler(onLoginSuccess)
        .withFailureHandler(onError)
        .login(nickname, password);
}

function onLoginSuccess(result) {
    hideLoader();
    
    if (result.success) {
        currentUser = result.user;
        showApp();
    } else {
        alert(result.message);
    }
}

// 회원가입 처리
function handleRegister(e) {
    e.preventDefault();
    showLoader();
    
    var password = document.getElementById('regPassword').value;
    var passwordConfirm = document.getElementById('regPasswordConfirm').value;
    
    // 비밀번호 확인
    if (password !== passwordConfirm) {
        hideLoader();
        alert('비밀번호가 일치하지 않습니다.');
        return;
    }
    
    // 비밀번호 강도 체크 (선택사항)
    if (password.length < 6) {
        hideLoader();
        alert('비밀번호는 6자 이상이어야 합니다.');
        return;
    }
    
    var userData = {
        nickname: document.getElementById('regNickname').value,
        guild: document.getElementById('regGuild').value,
        server: document.getElementById('regServer').value,
        job: document.getElementById('regJob').value,  // 직업 추가
        password: password
    };
    
    google.script.run
        .withSuccessHandler(onRegisterSuccess)
        .withFailureHandler(onError)
        .register(userData);
}

function onRegisterSuccess(result) {
    hideLoader();
    
    if (result.success) {
        alert(result.message);
        showLogin();
    } else {
        alert(result.message);
    }
}

// 앱 표시
function showApp() {
    // body 클래스 변경
    document.body.classList.remove('not-logged-in');
    document.body.classList.add('logged-in');
    
    // 로그인 컨테이너 숨김
    document.getElementById('loginContainer').style.display = 'none';
    
    // 앱 컨테이너 표시
    var appContainer = document.getElementById('appContainer');
    appContainer.style.display = 'block';
    appContainer.style.visibility = 'visible';
    appContainer.style.opacity = '1';
    appContainer.classList.add('show');
    
    // 사용자 정보 표시
    document.getElementById('userName').textContent = currentUser.nickname;
    document.getElementById('userRole').textContent = currentUser.isAdmin ? '관리자' : '일반 회원';
    
    // 관리자 메뉴 표시
    if (currentUser.isAdmin) {
        var adminElements = document.querySelectorAll('.admin-only');
        for (var i = 0; i < adminElements.length; i++) {
            adminElements[i].style.removeProperty('display');
            adminElements[i].classList.add('show');
        }
    }
    
    // 대시보드 로드
    showPage('dashboard');
}

// 로그아웃
function logout() {
    currentUser = null;
    
    // body 클래스 변경
    document.body.classList.remove('logged-in');
    document.body.classList.add('not-logged-in');
    
    // 앱 컨테이너 숨김
    var appContainer = document.getElementById('appContainer');
    appContainer.classList.remove('show');
    appContainer.style.display = 'none';
    appContainer.style.visibility = 'hidden';
    appContainer.style.opacity = '0';
    
    // 로그인 컨테이너 표시
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('loginForm').reset();
}

// 페이지 네비게이션
function showPage(page) {
    currentPage = page;
    
    // 메뉴 활성화 표시
    var menuItems = document.querySelectorAll('.menu-item');
    for (var i = 0; i < menuItems.length; i++) {
        menuItems[i].classList.remove('active');
    }
    
    // 클릭된 메뉴 활성화
    var clickedMenu = null;
    for (var i = 0; i < menuItems.length; i++) {
        var onclick = menuItems[i].getAttribute('onclick');
        if (onclick && onclick.includes(page)) {
            clickedMenu = menuItems[i];
            break;
        }
    }
    if (clickedMenu) {
        clickedMenu.classList.add('active');
    }
    
    // 페이지 콘텐츠 로드
    switch(page) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'members':
            loadMembers();
            break;
        case 'boss-history':
            loadBossHistory();
            break;
        case 'boss-record':
            loadBossRecord();
            break;
        case 'item-sales':
            loadItemSales();
            break;
        case 'guild-funds':
            loadGuildFunds();
            break;
        case 'distribution':
            loadDistribution();
            break;
        case 'statistics':
            loadStatistics();
            break;
        case 'admin':
            loadAdmin();
            break;
    }
}

// 대시보드 로드
function loadDashboard() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            hideLoader();
            // 최근 활동 로드
            loadRecentActivities();
        })
        .withFailureHandler(onError)
        .getDashboardHTML();
}

// 최근 활동 로드
function loadRecentActivities() {
    // 구현할 함수 - 임시로 비워둠
}

// 보스 참여 등록 로드
function loadBossRecord() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            document.getElementById('bossRecordForm').addEventListener('submit', handleBossRecord);
            hideLoader();
        })
        .withFailureHandler(onError)
        .getBossRecordHTML();
}

// 이미지 업로드 처리
function handleImageUpload(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var base64 = e.target.result.split(',')[1];
            extractParticipants(base64);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Gemini API로 참여자 추출
function extractParticipants(base64) {
    showLoader();
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                displayExtractedParticipants(result.nicknames);
            } else {
                alert(result.message);
            }
            hideLoader();
        })
        .withFailureHandler(onError)
        .extractParticipantsFromImage(base64);
}

// 추출된 참여자 표시
function displayExtractedParticipants(nicknames) {
    var container = document.getElementById('extractedParticipants');
    var list = document.getElementById('participantList');
    
    container.style.display = 'block';
    list.innerHTML = '';
    
    window.extractedNicknames = nicknames; // 전역 변수에 저장
    
    for (var i = 0; i < nicknames.length; i++) {
        var item = document.createElement('div');
        item.className = 'participant-item';
        item.innerHTML = '<span>' + nicknames[i] + '</span>' +
            '<button class="btn btn-sm" onclick="removeParticipant(' + i + ')">' +
            '<span class="material-icons">close</span></button>';
        list.appendChild(item);
    }
    
    updateParticipantCount();
}

// 참여자 제거
function removeParticipant(index) {
    window.extractedNicknames.splice(index, 1);
    displayExtractedParticipants(window.extractedNicknames);
}

// 참여자 수 업데이트
function updateParticipantCount() {
    var extracted = document.querySelectorAll('.participant-item').length;
    var additionalInput = document.getElementById('additionalParticipants');
    var additional = 0;
    
    if (additionalInput && additionalInput.value) {
        var additionalList = additionalInput.value.split(',');
        additional = additionalList.filter(function(p) { 
            return p.trim(); 
        }).length;
    }
    
    var totalElement = document.getElementById('totalParticipants');
    if (totalElement) {
        totalElement.textContent = (extracted + additional) + '명';
    }
}

// 보스 기록 저장
function handleBossRecord(e) {
    e.preventDefault();
    showLoader();
    
    var participants = [];
    
    // 추출된 참여자
    if (window.extractedNicknames) {
        participants = participants.concat(window.extractedNicknames);
    }
    
    // 추가 참여자
    var additional = document.getElementById('additionalParticipants').value;
    if (additional) {
        var additionalList = additional.split(',');
        for (var i = 0; i < additionalList.length; i++) {
            var participant = additionalList[i].trim();
            if (participant) {
                participants.push(participant);
            }
        }
    }
    
    var recordData = {
        bossName: document.getElementById('bossName').value,
        participants: participants,
        item: document.getElementById('itemName').value,
        itemCount: parseInt(document.getElementById('itemCount').value) || 0
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                alert(result.message);
                loadBossRecord(); // 페이지 새로고침
            }
            hideLoader();
        })
        .withFailureHandler(onError)
        .saveBossRecord(recordData);
}

// ===== 길드원 목록 페이지 관련 함수들 =====

// 길드원 목록 페이지 로드
function loadMembers() {
    console.log('길드원 목록 페이지 로드 시작');
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('길드원 목록 HTML 로드 성공');
            document.getElementById('contentWrapper').innerHTML = html;
            // HTML 로드 후 바로 데이터 로드
            setTimeout(function() {
                loadMembersData();
            }, 100);
            hideLoader();
        })
        .withFailureHandler(function(error) {
            console.error('길드원 목록 HTML 로드 실패:', error);
            hideLoader();
            alert('길드원 목록을 불러오는데 실패했습니다: ' + error.message);
        })
        .getMembersHTML();
}

// 길드원 데이터 로드 및 표시 함수 (개선됨)
function loadMembersData() {
    console.log('길드원 데이터 로드 시작');
    showLoader();
    
    // 디버깅을 위해 먼저 시트 상태 확인
    google.script.run
        .withSuccessHandler(function() {
            console.log('시트 디버깅 완료, 실제 데이터 로드 시작');
            
            // 실제 회원 데이터 로드
            google.script.run
                .withSuccessHandler(function(members) {
                    console.log('길드원 데이터 로드 성공:', members);
                    hideLoader();
                    
                    if (members && members.length > 0) {
                        console.log('회원 데이터 존재, 테이블 표시');
                        displayMembersTable(members);
                        updateMembersStats(members);
                        drawParticipationChart(members);
                    } else {
                        console.log('회원 데이터 없음, 빈 메시지 표시');
                        displayEmptyMembersMessage();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('길드원 데이터 로드 실패:', error);
                    hideLoader();
                    displayErrorMessage('길드원 데이터를 불러오는데 실패했습니다: ' + error.message);
                })
                .getMembers();
        })
        .withFailureHandler(function(error) {
            console.error('시트 디버깅 실패:', error);
            hideLoader();
        })
        .debugMemberSheet();
}

// 길드원 테이블 표시 함수 (개선됨)
function displayMembersTable(members) {
    console.log('길드원 테이블 표시 시작:', members.length + '명');
    
    var tbody = document.getElementById('membersTableBody');
    if (!tbody) {
        console.error('membersTableBody 요소를 찾을 수 없습니다');
        return;
    }
    
    if (!members || members.length === 0) {
        displayEmptyMembersMessage();
        return;
    }
    
    var html = '';
    var totalParticipation = members.reduce(function(sum, member) {
        return sum + (member.participationCount || 0);
    }, 0);
    
    console.log('총 참여 횟수:', totalParticipation);
    
    for (var i = 0; i < members.length; i++) {
        var member = members[i];
        console.log('회원 처리 중:', member.nickname, '참여횟수:', member.participationCount);
        
        var participationRate = totalParticipation > 0 ? 
            Math.round((member.participationCount / totalParticipation) * 100) : 0;
        
        var statusClass = member.status === '활성' ? 'active' : 'inactive';
        var jobColor = getJobColor(member.job);
        var roleText = member.isAdmin ? '관리자' : '일반회원';
        var roleClass = member.isAdmin ? 'admin' : 'member';
        
        var lastParticipationText = member.lastParticipation ? 
            new Date(member.lastParticipation).toLocaleDateString() : '참여 없음';
        
        html += '<tr class="member-row" data-status="' + member.status + '" data-job="' + member.job + '">' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td>' +
                '<div class="member-name-cell">' +
                    '<div class="member-avatar-sm">' +
                        '<span class="avatar-text">' + (member.nickname ? member.nickname.substring(0, 1) : '?') + '</span>' +
                    '</div>' +
                    '<strong class="member-nickname">' + (member.nickname || 'Unknown') + '</strong>' +
                '</div>' +
            '</td>' +
            '<td>' + (member.guild || '-') + '</td>' +
            '<td>' + (member.server || '-') + '</td>' +
            '<td>' +
                '<span class="job-badge" style="background-color: ' + jobColor + '20; color: ' + jobColor + '; border: 1px solid ' + jobColor + '40;">' +
                    (member.job || '미설정') +
                '</span>' +
            '</td>' +
            '<td>' + (member.joinDate ? new Date(member.joinDate).toLocaleDateString() : '-') + '</td>' +
            '<td><span class="status-badge ' + statusClass + '">' + (member.status || '활성') + '</span></td>' +
            '<td>' +
                '<div class="participation-cell">' +
                    '<strong>' + (member.participationCount || 0) + '회</strong>' +
                '</div>' +
            '</td>' +
            '<td>' +
                '<div class="participation-rate">' +
                    '<div class="rate-bar">' +
                        '<div class="rate-fill" style="width: ' + Math.min(participationRate * 2, 100) + '%"></div>' +
                    '</div>' +
                    '<span class="rate-text">' + participationRate + '%</span>' +
                '</div>' +
            '</td>' +
            '<td>' + lastParticipationText + '</td>' +
            '<td><span class="role-badge ' + roleClass + '">' + roleText + '</span></td>' +
        '</tr>';
    }
    
    tbody.innerHTML = html;
    console.log('테이블 HTML 설정 완료');
    
    // 테이블 행에 클릭 이벤트 추가
    var rows = document.querySelectorAll('.member-row');
    for (var i = 0; i < rows.length; i++) {
        rows[i].addEventListener('click', function() {
            var nickname = this.querySelector('.member-nickname').textContent;
            showMemberDetail(nickname);
        });
    }
    
    console.log('테이블 이벤트 설정 완료');
}

// 통계 업데이트 함수 (안전성 개선)
function updateMembersStats(members) {
    console.log('회원 통계 업데이트:', members.length + '명');
    
    var total = members ? members.length : 0;
    var active = members ? members.filter(function(m) { return m.status === '활성'; }).length : 0;
    var inactive = total - active;
    var totalParticipation = members ? members.reduce(function(sum, member) {
        return sum + (member.participationCount || 0);
    }, 0) : 0;
    
    // 안전하게 요소 업데이트
    function updateElementText(id, text) {
        var element = document.getElementById(id);
        if (element) {
            element.textContent = text;
        } else {
            console.warn('요소를 찾을 수 없음:', id);
        }
    }
    
    updateElementText('totalMembersCount', total + '명');
    updateElementText('activeMembersCount', active + '명');
    updateElementText('inactiveMembersCount', inactive + '명');
    updateElementText('totalParticipationCount', totalParticipation + '회');
    
    console.log('통계 업데이트 완료 - 총:', total, '활성:', active, '참여:', totalParticipation);
}

// 빈 메시지 표시 (개선됨)
function displayEmptyMembersMessage() {
    console.log('빈 회원 메시지 표시');
    
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="empty-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px;">people_outline</span>' +
                '<p>등록된 길드원이 없습니다.</p>' +
                '<p style="font-size: 14px; color: #aaa; margin: 8px 0;">회원 가입을 통해 길드원을 등록하거나</p>' +
                '<p style="font-size: 14px; color: #aaa; margin: 8px 0;">관리자에게 문의하세요.</p>' +
                '<div style="margin-top: 20px;">' +
                    '<button class="btn btn-primary" onclick="showPage(\'admin\'); return false;" style="margin-right: 10px;">길드원 관리하기</button>' +
                    '<button class="btn btn-secondary" onclick="loadMembersData(); return false;">다시 시도</button>' +
                '</div>' +
            '</div>' +
        '</td></tr>';
    }
    
    // 통계도 0으로 업데이트
    updateMembersStats([]);
}

// 에러 메시지 표시 (개선됨)
function displayErrorMessage(message) {
    console.log('에러 메시지 표시:', message);
    
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="error-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px; color: #f44336;">error</span>' +
                '<p style="color: #f44336; font-weight: 500;">오류가 발생했습니다</p>' +
                '<p style="font-size: 14px; margin: 8px 0;">' + message + '</p>' +
                '<div style="margin-top: 20px;">' +
                    '<button class="btn btn-secondary" onclick="loadMembersData(); return false;" style="margin-right: 10px;">다시 시도</button>' +
                    '<button class="btn btn-outline" onclick="debugMembers(); return false;">문제 진단</button>' +
                '</div>' +
            '</div>' +
        '</td></tr>';
    }
    
    // 통계도 0으로 업데이트  
    updateMembersStats([]);
}

// 문제 진단 함수
function debugMembers() {
    console.log('회원 목록 문제 진단 시작');
    showLoader();
    
    google.script.run
        .withSuccessHandler(function() {
            console.log('진단 완료');
            hideLoader();
            alert('진단이 완료되었습니다. 브라우저 개발자 도구의 콘솔을 확인하세요.');
        })
        .withFailureHandler(function(error) {
            console.error('진단 실패:', error);
            hideLoader();
            alert('진단 중 오류가 발생했습니다: ' + error.message);
        })
        .checkAllSheets();
}

// ===== 목록 내보내기 = 새로고침 기능으로 변경 =====
function exportMembersList() {
    console.log('목록 새로고침 실행 (기존 내보내기 버튼)');
    refreshMembersList();
}

function refreshMembersList() {
    console.log('길드원 목록 새로고침');
    loadMembersData();
}

// 검색 및 필터링 함수들 (개선됨)
function searchMembers(keyword) {
    console.log('회원 검색:', keyword);
    
    var rows = document.querySelectorAll('.member-row');
    var lowerKeyword = keyword.toLowerCase();
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var nicknameElement = row.querySelector('.member-nickname');
        
        if (nicknameElement) {
            var nickname = nicknameElement.textContent.toLowerCase();
            
            if (!keyword || nickname.includes(lowerKeyword)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    console.log('검색 결과:', visibleCount + '명 표시');
}

function filterMembers(status) {
    console.log('회원 상태 필터:', status);
    
    var rows = document.querySelectorAll('.member-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberStatus = row.getAttribute('data-status');
        
        if (status === 'all' || memberStatus === status) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    console.log('필터 결과:', visibleCount + '명 표시');
}

function filterMembersByJob(job) {
    console.log('회원 직업 필터:', job);
    
    var rows = document.querySelectorAll('.member-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberJob = row.getAttribute('data-job');
        
        if (job === 'all' || memberJob === job) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    console.log('직업 필터 결과:', visibleCount + '명 표시');
}

// 정렬 함수 (개선됨)
function sortMembers(sortBy) {
    console.log('회원 정렬:', sortBy);
    // 현재는 단순히 데이터를 다시 로드하지만, 나중에 클라이언트 사이드 정렬로 개선 가능
    loadMembersData();
}

// 회원 상세 정보 표시
function showMemberDetail(nickname) {
    console.log('회원 상세 정보 표시:', nickname);
    
    // 현재는 간단한 알림만 표시, 나중에 모달로 개선 가능
    alert('회원 상세 정보: ' + nickname + '\n\n상세 정보 기능은 준비 중입니다.\n\n구현 예정 기능:\n- 참여 히스토리\n- 획득 아이템\n- 활동 통계\n- 메모 관리');
}

// 참여율 차트 그리기
function drawParticipationChart(members) {
    console.log('참여율 차트 그리기');
    
    var canvas = document.getElementById('participationChart');
    if (canvas && members && members.length > 0) {
        var ctx = canvas.getContext('2d');
        
        // 캔버스 초기화
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 배경
        ctx.fillStyle = '#F8FAFC';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 차트 제목
        ctx.fillStyle = '#00BCD4';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('참여율 분포 (준비 중)', canvas.width/2, canvas.height/2 - 10);
        
        // 부제목
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.fillText('총 ' + members.length + '명의 길드원', canvas.width/2, canvas.height/2 + 15);
        
        console.log('차트 그리기 완료');
    } else if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#E0E0E0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('데이터 없음', canvas.width/2, canvas.height/2);
    }
}
    
  

// 통계 업데이트 함수
function updateMembersStats(members) {
    var total = members.length;
    var active = members.filter(function(m) { return m.status === '활성'; }).length;
    var inactive = total - active;
    var totalParticipation = members.reduce(function(sum, member) {
        return sum + (member.participationCount || 0);
    }, 0);
    
    var totalMembersEl = document.getElementById('totalMembersCount');
    var activeMembersEl = document.getElementById('activeMembersCount');
    var inactiveMembersEl = document.getElementById('inactiveMembersCount');
    var totalParticipationEl = document.getElementById('totalParticipationCount');
    
    if (totalMembersEl) totalMembersEl.textContent = total + '명';
    if (activeMembersEl) activeMembersEl.textContent = active + '명';
    if (inactiveMembersEl) inactiveMembersEl.textContent = inactive + '명';
    if (totalParticipationEl) totalParticipationEl.textContent = totalParticipation + '회';
}

// 빈 메시지 표시
function displayEmptyMembersMessage() {
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="empty-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px;">people_outline</span>' +
                '<p>등록된 길드원이 없습니다.</p>' +
                '<button class="btn btn-primary" onclick="showPage(\'admin\')">길드원 관리하기</button>' +
            '</div>' +
        '</td></tr>';
    }
}

// 에러 메시지 표시
function displayErrorMessage(message) {
    var tbody = document.getElementById('membersTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">' +
            '<div class="error-members">' +
                '<span class="material-icons" style="font-size: 48px; margin-bottom: 16px; color: #f44336;">error</span>' +
                '<p>' + message + '</p>' +
                '<button class="btn btn-secondary" onclick="loadMembersData()">다시 시도</button>' +
            '</div>' +
        '</td></tr>';
    }
}

// 검색 및 필터링 함수들
function searchMembers(keyword) {
    var rows = document.querySelectorAll('.member-row');
    var lowerKeyword = keyword.toLowerCase();
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var nickname = row.querySelector('.member-nickname').textContent.toLowerCase();
        
        if (nickname.includes(lowerKeyword)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function filterMembers(status) {
    var rows = document.querySelectorAll('.member-row');
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberStatus = row.getAttribute('data-status');
        
        if (status === 'all' || memberStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function filterMembersByJob(job) {
    var rows = document.querySelectorAll('.member-row');
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var memberJob = row.getAttribute('data-job');
        
        if (job === 'all' || memberJob === job) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// 정렬 함수
function sortMembers(sortBy) {
    // 현재 표시된 데이터를 다시 정렬해서 표시
    loadMembersData(); // 간단하게 데이터를 다시 로드
}

// 기타 함수들
function exportMembersList() {
    alert('길드원 목록 내보내기 기능은 준비 중입니다.');
}

function refreshMembersList() {
    loadMembersData();
}

function showMemberDetail(nickname) {
    alert('회원 상세 정보: ' + nickname + '\n(상세 기능은 준비 중입니다)');
}

function drawParticipationChart(members) {
    // 간단한 참여율 차트 그리기
    var canvas = document.getElementById('participationChart');
    if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#E0E0E0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#00BCD4';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('참여율 차트 (준비 중)', canvas.width/2, canvas.height/2);
    }
}

// 직업별 색상 반환 함수
function getJobColor(job) {
    var jobColors = {
        // 전사 계열 - 빨간색 계열
        '버서커': '#E53E3E',
        '디스트로이어': '#C53030',
        '워로드': '#9B2C2C',
        '홀리나이트': '#742A2A',
        '슬레이어': '#E53E3E',
        
        // 무도가 계열 - 주황색 계열
        '배틀마스터': '#DD6B20',
        '인파이터': '#C05621',
        '기공사': '#9C4221',
        '창술사': '#7B341E',
        '스트라이커': '#DD6B20',
        '브레이커': '#C05621',
        
        // 건너 계열 - 녹색 계열
        '건슬링어': '#38A169',
        '아르티스트': '#2F855A',
        '데빌헌터': '#276749',
        '블래스터': '#22543D',
        '호크아이': '#1A202C',
        '스카우터': '#38A169',
        
        // 마법사 계열 - 파란색 계열
        '바드': '#3182CE',
        '서머너': '#2B6CB0',
        '아르카나': '#2C5282',
        '소서리스': '#2A4365',
        
        // 암살자 계열 - 보라색 계열
        '블레이드': '#805AD5',
        '데모닉': '#6B46C1',
        '리퍼': '#553C9A',
        '소울이터': '#44337A',
        
        // 스페셜리스트 계열 - 특별색
        '도화가': '#D69E2E',
        '기상술사': '#00B5D8'
    };
    
    return jobColors[job] || '#718096'; // 기본 회색
}

// ===== 기존 함수들 계속 =====

// 아이템 판매 페이지 로드
function loadItemSales() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            loadUnsoldItems();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getItemSalesHTML();
}

// 길드 자금 페이지 로드
function loadGuildFunds() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            var form = document.getElementById('fundTransactionForm');
            if (form) {
                form.addEventListener('submit', handleFundTransaction);
            }
            loadTransactionHistory();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getGuildFundsHTML();
}

// 기타 페이지 로드 함수들
function loadBossHistory() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            loadBossHistoryData();
            hideLoader();
        })
        .withFailureHandler(onError)
        .getBossHistoryHTML();
}

function loadDistribution() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(html) {
            document.getElementById('contentWrapper').innerHTML = html;
            hideLoader();
        })
        .withFailureHandler(onError)
        .getDistributionHTML();
}

// 통계 페이지 로드
function loadStatistics() {
    console.log('통계 페이지 로드 시작');
    showLoader();
    
    // 먼저 HTML을 로드한 후 데이터를 불러옴
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('통계 HTML 로드 성공');
            document.getElementById('contentWrapper').innerHTML = html;
            // HTML이 로드된 후 데이터 로드
            loadStatisticsData();
            hideLoader();
        })
        .withFailureHandler(function(error) {
            console.error('통계 HTML 로드 실패:', error);
            onError(error);
        })
        .getStatisticsHTML();
}

function loadStatisticsData() {
    console.log('통계 데이터 로드 시작');
    
    // 보스 통계 로드
    google.script.run
        .withSuccessHandler(function(statistics) {
            console.log('보스 통계 로드 성공:', statistics);
            if (statistics && statistics.bossStats && statistics.memberStats) {
                displayParticipationRanking(statistics.memberStats);
                displayBossStatisticsChart(statistics.bossStats);
            } else {
                console.warn('통계 데이터가 비어있습니다');
                displayEmptyStatistics();
            }
        })
        .withFailureHandler(function(error) {
            console.error('보스 통계 로드 실패:', error);
            displayEmptyStatistics();
        })
        .getBossStatistics();
}

function displayEmptyStatistics() {
    // 참여율 순위 테이블에 빈 메시지 표시
    var participationTbody = document.getElementById('participationRankingBody');
    if (participationTbody) {
        participationTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">참여 기록이 없습니다.</td></tr>';
    }
    
    // 보스 통계에 빈 메시지 표시
    var bossStatsDiv = document.getElementById('bossStatistics');
    if (bossStatsDiv) {
        bossStatsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">보스 통계 데이터가 없습니다.</p>';
    }
}

function displayParticipationRanking(memberStats) {
    console.log('참여율 순위 표시 시작:', memberStats);
    var tbody = document.getElementById('participationRankingBody');
    if (!tbody) {
        console.error('participationRankingBody 요소를 찾을 수 없습니다');
        return;
    }
    
    var html = '';
    var totalParticipation = 0;
    
    // 전체 참여 횟수 계산
    for (var i = 0; i < memberStats.length; i++) {
        totalParticipation += memberStats[i].totalParticipation;
    }
    
    for (var i = 0; i < Math.min(memberStats.length, 15); i++) {
        var member = memberStats[i];
        var participationRate = totalParticipation > 0 ? 
            Math.round((member.totalParticipation / totalParticipation) * 100) : 0;
        
        html += '<tr>' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td><strong>' + member.nickname + '</strong></td>' +
            '<td>-</td>' + // 직업 정보
            '<td>' + member.totalParticipation + '회</td>' +
            '<td>' + participationRate + '%</td>' +
            '<td>-</td>' + // 획득 아이템
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">참여 기록이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
    console.log('참여율 순위 표시 완료');
}

function displayBossStatisticsChart(bossStats) {
    console.log('보스 통계 차트 표시 시작:', bossStats);
    var container = document.getElementById('bossStatistics');
    if (!container) {
        console.error('bossStatistics 요소를 찾을 수 없습니다');
        return;
    }
    
    var html = '<div class="boss-stats-cards">';
    
    for (var i = 0; i < bossStats.length; i++) {
        var stat = bossStats[i];
        html += '<div class="boss-stat-card">' +
            '<h4>' + stat.bossName + '</h4>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">총 레이드</span>' +
                '<span class="stat-value">' + stat.totalRaids + '회</span>' +
            '</div>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">평균 참여자</span>' +
                '<span class="stat-value">' + stat.averageParticipants + '명</span>' +
            '</div>' +
            '<div class="boss-stat-item">' +
                '<span class="stat-label">총 아이템</span>' +
                '<span class="stat-value">' + stat.totalItems + '개</span>' +
            '</div>' +
        '</div>';
    }
    
    html += '</div>';
    
    if (bossStats.length === 0) {
        html = '<p style="text-align: center; color: #999; padding: 40px;">보스 통계 데이터가 없습니다.</p>';
    }
    
    container.innerHTML = html;
    console.log('보스 통계 차트 표시 완료');
}

// 관리자 페이지 로드
function loadAdmin() {
    if (!currentUser || !currentUser.isAdmin) {
        alert('관리자 권한이 필요합니다.');
        return;
    }
    
    console.log('관리자 페이지 로드 시작');
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(html) {
            console.log('관리자 HTML 로드 성공');
            document.getElementById('contentWrapper').innerHTML = html;
            
            // 관리자 페이지 초기화
            initializeAdminPage();
            
            hideLoader();
        })
        .withFailureHandler(function(error) {
            console.error('관리자 페이지 로드 실패:', error);
            onError(error);
        })
        .getAdminHTML();
}

// 관리자 페이지 초기화
function initializeAdminPage() {
    console.log('관리자 페이지 초기화');
    
    // 관리자 대시보드 데이터 로드
    loadAdminDashboardData();
    
    // 관리자 회원 목록 로드
    loadAdminMembersData();
}

// 관리자 대시보드 데이터 로드
function loadAdminDashboardData() {
    google.script.run
        .withSuccessHandler(function(data) {
            updateAdminDashboard(data);
        })
        .withFailureHandler(onError)
        .getDashboardData();
}

// 관리자 회원 데이터 로드
function loadAdminMembersData() {
    google.script.run
        .withSuccessHandler(function(members) {
            displayAdminMembersTable(members);
        })
        .withFailureHandler(onError)
        .getMembers();
}

// 관리자 대시보드 업데이트
function updateAdminDashboard(data) {
    // 통계 카드 업데이트 로직
    console.log('관리자 대시보드 업데이트:', data);
}

// 관리자 회원 테이블 표시
function displayAdminMembersTable(members) {
    var tbody = document.querySelector('#adminMemberTable tbody');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < members.length; i++) {
        var member = members[i];
        var roleText = member.isAdmin ? '관리자' : '일반회원';
        var statusClass = member.status === '활성' ? 'active' : 'inactive';
        
        html += '<tr>' +
            '<td><input type="checkbox" class="member-checkbox" value="' + member.id + '"></td>' +
            '<td>' + member.id + '</td>' +
            '<td><strong>' + member.nickname + '</strong></td>' +
            '<td>' + member.guild + '</td>' +
            '<td>' + member.server + '</td>' +
            '<td>' + (member.job || '-') + '</td>' +
            '<td>' + new Date(member.joinDate).toLocaleDateString() + '</td>' +
            '<td><span class="status-badge ' + statusClass + '">' + member.status + '</span></td>' +
            '<td>' + roleText + '</td>' +
            '<td>' +
                '<button class="btn-icon" onclick="editMember(\'' + member.id + '\')" title="편집">' +
                    '<span class="material-icons">edit</span>' +
                '</button>' +
                '<button class="btn-icon" onclick="toggleMemberStatus(\'' + member.id + '\')" title="상태변경">' +
                    '<span class="material-icons">toggle_on</span>' +
                '</button>' +
            '</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="10" style="text-align: center; color: #999;">등록된 회원이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

// 관리자 탭 전환
function showAdminTab(tabName) {
    console.log('관리자 탭 전환:', tabName);
    
    // 모든 탭 버튼에서 active 클래스 제거
    var tabBtns = document.querySelectorAll('.tab-btn');
    for (var i = 0; i < tabBtns.length; i++) {
        tabBtns[i].classList.remove('active');
    }
    
    // 모든 탭 콘텐츠 숨김
    var tabContents = document.querySelectorAll('.tab-content');
    for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].style.display = 'none';
    }
    
    // 클릭된 탭 버튼 활성화
    var clickedBtn = null;
    for (var i = 0; i < tabBtns.length; i++) {
        var onclick = tabBtns[i].getAttribute('onclick');
        if (onclick && onclick.includes(tabName)) {
            clickedBtn = tabBtns[i];
            break;
        }
    }
    if (clickedBtn) {
        clickedBtn.classList.add('active');
    }
    
    // 해당 탭 콘텐츠 표시
    var targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
        targetTab.style.display = 'block';
    }
    
    // 탭별 데이터 로드
    switch(tabName) {
        case 'members':
            loadAdminMembersData();
            break;
        case 'roles':
            loadRoleManagementData();
            break;
        case 'settings':
            loadSystemSettings();
            break;
    }
}

// 권한 관리 데이터 로드
function loadRoleManagementData() {
    google.script.run
        .withSuccessHandler(function(roleData) {
            displayRoleManagement(roleData);
        })
        .withFailureHandler(onError)
        .getMembersByRole();
}

// 권한 관리 표시
function displayRoleManagement(roleData) {
    // 관리자 목록
    var adminList = document.getElementById('adminList');
    if (adminList && roleData.admin) {
        adminList.innerHTML = roleData.admin.map(function(member) {
            return '<span class="member-chip">' + member.nickname + '</span>';
        }).join('');
    }
    
    // 부관리자 목록
    var subAdminList = document.getElementById('subAdminList');
    if (subAdminList && roleData.subadmin) {
        subAdminList.innerHTML = roleData.subadmin.map(function(member) {
            return '<span class="member-chip">' + member.nickname + 
                   ' <button onclick="removeMemberRole(\'' + member.id + '\')">×</button></span>';
        }).join('');
    }
    
    // 운영진 목록
    var moderatorList = document.getElementById('moderatorList');
    if (moderatorList && roleData.moderator) {
        moderatorList.innerHTML = roleData.moderator.map(function(member) {
            return '<span class="member-chip">' + member.nickname + 
                   ' <button onclick="removeMemberRole(\'' + member.id + '\')">×</button></span>';
        }).join('');
    }
}

// 사이드바 토글
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

// 숫자 포맷
function formatNumber(num) {
    return new Intl.NumberFormat('ko-KR').format(num);
}

// 에러 처리
function onError(error) {
    hideLoader();
    console.error('Error:', error);
    alert('오류가 발생했습니다: ' + (error.message || error));
}

// 차트 그리기 함수
function drawDoughnutChart(canvas) {
    var ctx = canvas.getContext('2d');
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;
    var radius = 80;
    
    // 도넛 차트 그리기 (간단한 예시)
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = '#E0E0E0';
    ctx.lineWidth = 20;
    ctx.stroke();
    
    // 실제 데이터 부분
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI/2, Math.PI);
    ctx.strokeStyle = '#00BCD4';
    ctx.lineWidth = 20;
    ctx.stroke();
}

// 기타 빈 함수들 (필요시 구현)
function loadUnsoldItems() {
    // 미판매 아이템 로드 로직
}

function loadTransactionHistory() {
    // 거래 내역 로드 로직
}

// 보스 히스토리 데이터 로드
function loadBossHistoryData() {
    // 보스 통계 로드
    google.script.run
        .withSuccessHandler(function(statistics) {
            displayBossStatistics(statistics.bossStats);
            displayMemberStatistics(statistics.memberStats);
        })
        .withFailureHandler(onError)
        .getBossStatistics();
    
    // 최근 보스 기록 로드
    google.script.run
        .withSuccessHandler(displayRecentBossHistory)
        .withFailureHandler(onError)
        .getRecentBossRecords(20);
}

// 보스 통계 표시
function displayBossStatistics(bossStats) {
    var tbody = document.getElementById('bossStatsTable');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < bossStats.length; i++) {
        var stat = bossStats[i];
        html += '<tr>' +
            '<td><strong>' + stat.bossName + '</strong></td>' +
            '<td>' + stat.totalRaids + '회</td>' +
            '<td>' + stat.averageParticipants + '명</td>' +
            '<td>' + stat.uniqueParticipants + '명</td>' +
            '<td>' + stat.totalItems + '개</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">등록된 보스 기록이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

// 멤버 통계 표시
function displayMemberStatistics(memberStats) {
    var tbody = document.getElementById('participationRankingTable');
    if (!tbody) return;
    
    var html = '';
    var totalParticipation = 0;
    
    // 전체 참여 횟수 계산
    for (var i = 0; i < memberStats.length; i++) {
        totalParticipation += memberStats[i].totalParticipation;
    }
    
    for (var i = 0; i < Math.min(memberStats.length, 10); i++) {
        var member = memberStats[i];
        var participationRate = totalParticipation > 0 ? 
            Math.round((member.totalParticipation / totalParticipation) * 100) : 0;
        
        html += '<tr>' +
            '<td><span class="rank-badge">' + (i + 1) + '</span></td>' +
            '<td><strong>' + member.nickname + '</strong></td>' +
            '<td>-</td>' + // 직업 정보는 추후 연동
            '<td>' + member.totalParticipation + '회</td>' +
            '<td>' + participationRate + '%</td>' +
            '<td>' + new Date(member.lastParticipation).toLocaleDateString() + '</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">참여 기록이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

// 최근 보스 히스토리 표시
function displayRecentBossHistory(recentRecords) {
    var tbody = document.getElementById('recentBossHistory');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < recentRecords.length; i++) {
        var record = recentRecords[i];
        
        // 참여자 배지 생성
        var participantBadges = '';
        var colors = ['bg-green', 'bg-yellow', 'bg-blue', 'bg-purple', 'bg-orange'];
        
        for (var j = 0; j < Math.min(record.participants.length, 4); j++) {
            var participant = record.participants[j];
            var colorClass = colors[j % colors.length];
            participantBadges += '<span class="badge-circle ' + colorClass + '">' + 
                participant.substring(0, 1) + '</span>';
        }
        
        if (record.participants.length > 4) {
            participantBadges += '<span class="badge-more">+' + (record.participants.length - 4) + '</span>';
        }
        
        // 판매 상태 배지
        var statusClass = record.soldStatus === '판매완료' ? 'completed' : 'pending';
        
        html += '<tr>' +
            '<td>' + new Date(record.date).toLocaleDateString() + '</td>' +
            '<td><strong>' + record.bossName + '</strong></td>' +
            '<td><div class="participant-badges">' + participantBadges + '</div></td>' +
            '<td>' + (record.item || '-') + '</td>' +
            '<td><span class="status-badge ' + statusClass + '">' + record.soldStatus + '</span></td>' +
            '<td>' + (record.salePrice > 0 ? formatNumber(record.salePrice) + '원' : '-') + '</td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">최근 보스 기록이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

function handleFundTransaction(e) {
    e.preventDefault();
    // 자금 거래 처리 로직
}

function previewDistribution() {
    var weekNum = document.getElementById('targetWeek').value;
    var totalAmount = parseInt(document.getElementById('distributionAmount').value);
    
    if (!totalAmount || totalAmount <= 0) {
        alert('분배 총액을 입력해주세요.');
        return;
    }
    
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(distributions) {
            displayDistributionPreview(distributions, totalAmount);
            document.getElementById('distributionPreview').style.display = 'block';
            hideLoader();
        })
        .withFailureHandler(onError)
        .calculateWeeklyDistribution(weekNum);
}

function displayDistributionPreview(distributions, totalAmount) {
    var tbody = document.querySelector('#previewTable tbody');
    if (!tbody) return;
    
    var html = '';
    for (var i = 0; i < distributions.length; i++) {
        var dist = distributions[i];
        var baseAmount = Math.floor(totalAmount * (parseFloat(dist.rate) / 100));
        
        html += '<tr>' +
            '<td>' + (i + 1) + '</td>' +
            '<td><strong>' + dist.nickname + '</strong></td>' +
            '<td>' + dist.count + '회</td>' +
            '<td>' + dist.rate + '%</td>' +
            '<td>' + formatNumber(baseAmount) + '원</td>' +
            '<td><strong>' + formatNumber(baseAmount) + '원</strong></td>' +
        '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="6" style="text-align: center; color: #999;">해당 주차에 참여 기록이 없습니다.</td></tr>';
    }
    
    tbody.innerHTML = html;
}

function executeDistribution() {
    if (!confirm('정말로 분배를 실행하시겠습니까? 실행 후에는 되돌릴 수 없습니다.')) {
        return;
    }
    
    var weekNum = document.getElementById('targetWeek').value;
    var totalAmount = parseInt(document.getElementById('distributionAmount').value);
    
    showLoader();
    
    google.script.run
        .withSuccessHandler(function(distributions) {
            // 분배 실행 로직은 추후 구현
            alert('분배가 완료되었습니다.');
            hideLoader();
        })
        .withFailureHandler(onError)
        .calculateWeeklyDistribution(weekNum);
}

function closeSellModal() {
    var modal = document.getElementById('sellModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function closeEditModal() {
    var modal = document.getElementById('editMemberModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function filterBossHistory() {
    var periodFilter = document.getElementById('periodFilter').value;
    var bossFilter = document.getElementById('bossFilter').value;
    
    // 필터 적용하여 데이터 다시 로드
    var filter = {
        period: periodFilter,
        boss: bossFilter
    };
    
    showLoader();
    
    // 필터된 데이터로 통계 갱신
    google.script.run
        .withSuccessHandler(function(statistics) {
            displayBossStatistics(statistics.bossStats);
            displayMemberStatistics(statistics.memberStats);
            hideLoader();
        })
        .withFailureHandler(function(error) {
            onError(error);
            hideLoader();
        })
        .getBossStatistics();
}

function exportBossHistory() {
    // CSV 내보내기 기능 (추후 구현)
    alert('보스 히스토리 내보내기 기능은 준비 중입니다.');
}

function createBackup() {
    if (confirm('데이터를 백업하시겠습니까?')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoader();
                alert(result.message);
            })
            .withFailureHandler(onError)
            .createBackup();
    }
}

function runDataValidation() {
    showLoader();
    google.script.run
        .withSuccessHandler(function(errors) {
            hideLoader();
            if (errors.length === 0) {
                alert('데이터 검증 완료: 오류가 없습니다.');
            } else {
                alert('데이터 검증 오류:\n' + errors.join('\n'));
            }
        })
        .withFailureHandler(onError)
        .validateData();
}

function updateInactiveMembers() {
    if (confirm('30일 이상 미참여 회원을 비활성화하시겠습니까?')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function() {
                hideLoader();
                alert('비활성 회원 업데이트가 완료되었습니다.');
                loadAdminMembersData();
            })
            .withFailureHandler(onError)
            .batchUpdateMemberStatus();
    }
}

// 관리자 기능 함수들
function initializeAllSheets() {
    if (confirm('모든 시트를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoader();
                alert(result.message);
            })
            .withFailureHandler(onError)
            .initializeAllSheets();
    }
}

function searchAdminMembers(keyword) {
    var rows = document.querySelectorAll('#adminMemberTable tbody tr');
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var nickname = row.cells[2].textContent.toLowerCase();
        
        if (nickname.includes(keyword.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function toggleAllMembers(checkbox) {
    var checkboxes = document.querySelectorAll('.member-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = checkbox.checked;
    }
}

function executeBulkAction() {
    var action = document.getElementById('bulkAction').value;
    if (!action) {
        alert('작업을 선택해주세요.');
        return;
    }
    
    var selectedIds = [];
    var checkboxes = document.querySelectorAll('.member-checkbox:checked');
    for (var i = 0; i < checkboxes.length; i++) {
        selectedIds.push(checkboxes[i].value);
    }
    
    if (selectedIds.length === 0) {
        alert('대상을 선택해주세요.');
        return;
    }
    
    if (confirm(selectedIds.length + '명에 대해 ' + action + ' 작업을 실행하시겠습니까?')) {
        showLoader();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoader();
                alert(result.message);
                loadAdminMembersData();
            })
            .withFailureHandler(onError)
            .executeBulkMemberAction(selectedIds, action);
    }
}

function editMember(memberId) {
    // 회원 편집 모달 열기 (추후 구현)
    alert('회원 편집 기능은 준비 중입니다.');
}

function toggleMemberStatus(memberId) {
    if (confirm('회원 상태를 변경하시겠습니까?')) {
        // 회원 상태 토글 로직 (추후 구현)
        alert('회원 상태 변경 기능은 준비 중입니다.');
    }
}

function exportMembers() {
    // 회원 목록 내보내기 (추후 구현)
    alert('회원 목록 내보내기 기능은 준비 중입니다.');
}
</script>
